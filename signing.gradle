import java.util.Properties

android {
    signingConfigs {
        release {
            println "\n=== å¼€å§‹åˆå§‹åŒ–ç­¾åé…ç½® ==="
            
            // 1. æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œpropertiesæ–‡ä»¶
            def properties = [:]
            def propertiesFile = rootProject.file('signing.properties')
            if (propertiesFile.exists()) {
                println "å‘ç° signing.properties æ–‡ä»¶"
                propertiesFile.withInputStream { stream ->
                    properties.load(stream)
                }
            } else {
                println "æœªæ‰¾åˆ° signing.properties æ–‡ä»¶"
            }

            // è°ƒè¯•è¾“å‡ºå½“å‰é…ç½®æ¥æº
            println "| é…ç½®æ¥æºæ£€æŸ¥:"
            println "| STORE_FILE_BASE64: ${System.getenv('STORE_FILE_BASE64')?.take(10)}... (é•¿åº¦: ${System.getenv('STORE_FILE_BASE64')?.length() ?: 'æœªè®¾ç½®'})"
            println "| STORE_PASSWORD: ${System.getenv('STORE_PASSWORD') ? '*** (å·²è®¾ç½®)' : 'æœªè®¾ç½®'}"
            println "| KEY_ALIAS: ${System.getenv('KEY_ALIAS') ? '*** (å·²è®¾ç½®)' : 'æœªè®¾ç½®'}"
            println "| KEY_PASSWORD: ${System.getenv('KEY_PASSWORD') ? '*** (å·²è®¾ç½®)' : 'æœªè®¾ç½®'}"

            // 2. ä¼˜å…ˆå¤„ç†BASE64ç¼–ç çš„å¯†é’¥
            def keystoreBase64 = System.getenv("STORE_FILE_BASE64")?.trim()
            if (keystoreBase64) {
                println "\nğŸ”‘ æ­£åœ¨ä½¿ç”¨BASE64ç¯å¢ƒå˜é‡é…ç½®..."
                
                def tempKeystoreFile = file("${rootProject.projectDir}/temp_keystore.jks")
                try {
                    // å®‰å…¨å†™å…¥ä¸´æ—¶æ–‡ä»¶
                    tempKeystoreFile.withOutputStream { os ->
                        def decodedBytes = keystoreBase64.decodeBase64()
                        if (!decodedBytes) {
                            throw new GradleException("BASE64è§£ç å¤±è´¥ï¼è¯·æ£€æŸ¥STORE_FILE_BASE64å†…å®¹")
                        }
                        os.write(decodedBytes)
                        println "| ä¸´æ—¶å¯†é’¥æ–‡ä»¶å†™å…¥æˆåŠŸ (${decodedBytes.length} bytes)"
                    }

                    // éªŒè¯å¯†é’¥æ–‡ä»¶æœ‰æ•ˆæ€§
                    if (!tempKeystoreFile.exists() || tempKeystoreFile.length() == 0) {
                        throw new GradleException("ä¸´æ—¶å¯†é’¥æ–‡ä»¶åˆ›å»ºå¤±è´¥ï¼")
                    }

                    storeFile tempKeystoreFile
                    storePassword System.getenv("STORE_PASSWORD") ?: ""
                    keyAlias System.getenv("KEY_ALIAS") ?: ""
                    keyPassword System.getenv("KEY_PASSWORD") ?: ""

                    println "| ç­¾åé…ç½®å·²åº”ç”¨"
                    println "| storeFile: ${storeFile?.absolutePath}"
                    println "| keyAlias: ${keyAlias?.take(1)}***"

                    // æ„å»ºå®Œæˆåè‡ªåŠ¨æ¸…ç†
                    gradle.buildFinished {
                        if (tempKeystoreFile.exists()) {
                            tempKeystoreFile.delete()
                            println "| å·²æ¸…ç†ä¸´æ—¶å¯†é’¥æ–‡ä»¶"
                        }
                    }
                } catch (Exception e) {
                    if (tempKeystoreFile.exists()) {
                        tempKeystoreFile.delete()
                    }
                    throw new GradleException("ç­¾åé…ç½®å¤±è´¥: ${e.message}", e)
                }
            }
            // 3. å›é€€åˆ°propertiesæ–‡ä»¶/å•ç‹¬ç¯å¢ƒå˜é‡
            else {
                println "\nğŸ“ å°è¯•ä½¿ç”¨propertiesæ–‡ä»¶/å•ç‹¬ç¯å¢ƒå˜é‡é…ç½®..."
                
                def getConfigValue = { String name, String envName ->
                    return properties[name] ?: System.getenv(envName)
                }

                def storeFileValue = getConfigValue('storeFile', 'STORE_FILE')
                if (storeFileValue) {
                    storeFile file(storeFileValue)
                    storePassword getConfigValue('storePassword', 'STORE_PASSWORD') ?: ""
                    keyAlias getConfigValue('keyAlias', 'KEY_ALIAS') ?: ""
                    keyPassword getConfigValue('keyPassword', 'KEY_PASSWORD') ?: ""

                    println "| ä½¿ç”¨æ–‡ä»¶è·¯å¾„é…ç½®:"
                    println "| storeFile: ${storeFile?.absolutePath}"
                    println "| keyAlias: ${keyAlias?.take(1)}***"
                } else {
                    println "âš ï¸ æœªé…ç½®ä»»ä½•æœ‰æ•ˆçš„ç­¾åä¿¡æ¯"
                    // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸æ— ç­¾åæ„å»º
                }
            }
        }
    }

    // åº”ç”¨ç­¾åé…ç½®åˆ°releaseæ„å»º
    buildTypes {
        release {
            signingConfig signingConfigs.release
            println "Releaseæ„å»ºå°†ä½¿ç”¨: ${signingConfig?.name ?: 'æ— ç­¾åé…ç½®'}\n"
        }
    }
}
