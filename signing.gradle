import java.util.Properties
import java.io.FileInputStream

android {
    signingConfigs {
        release {
            println "\n=== å¼€å§‹åˆå§‹åŒ–ç­¾åé…ç½® ==="
            
            // 1. æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œpropertiesæ–‡ä»¶
            // æ˜ç¡®å£°æ˜ properties çš„ç±»å‹ï¼Œç¡®ä¿å®ƒæ˜¯ java.util.Properties
            Properties properties = new Properties() 
            def propertiesFile = rootProject.file('signing.properties')
            if (propertiesFile.exists()) {
                println "å‘ç° signing.properties æ–‡ä»¶"
                // ä½¿ç”¨ withInputStream é—­åŒ…æ¥è‡ªåŠ¨å¤„ç†æµçš„å…³é—­
                propertiesFile.withInputStream { stream ->
                    properties.load(stream)
                }
            } else {
                println "æœªæ‰¾åˆ° signing.properties æ–‡ä»¶"
            }

            // è°ƒè¯•è¾“å‡ºå½“å‰é…ç½®æ¥æº
            println "| é…ç½®æ¥æºæ£€æŸ¥:"
            println "| STORE_FILE_BASE64: ${System.getenv('STORE_FILE_BASE64')?.take(10)}... (é•¿åº¦: ${System.getenv('STORE_FILE_BASE64')?.length() ?: 'æœªè®¾ç½®'})"
            println "| STORE_PASSWORD: ${System.getenv('STORE_PASSWORD') ? '*** (å·²è®¾ç½®)' : 'æœªè®¾ç½®'}"
            println "| KEY_ALIAS: ${System.getenv('KEY_ALIAS') ? '*** (å·²è®¾ç½®)' : 'æœªè®¾ç½®'}"
            println "| KEY_PASSWORD: ${System.getenv('KEY_PASSWORD') ? '*** (å·²è®¾ç½®)' : 'æœªè®¾ç½®'}"

            // 2. ä¼˜å…ˆå¤„ç†BASE64ç¼–ç çš„å¯†é’¥
            def keystoreBase64 = System.getenv("STORE_FILE_BASE64")?.trim() // ä½¿ç”¨ trim() ç§»é™¤é¦–å°¾ç©ºç™½
            if (keystoreBase64) {
                println "\nğŸ”‘ æ­£åœ¨ä½¿ç”¨BASE64ç¯å¢ƒå˜é‡é…ç½®..."
                
                def tempKeystoreFile = file("${rootProject.projectDir}/temp_keystore.jks")
                try {
                    // å®‰å…¨å†™å…¥ä¸´æ—¶æ–‡ä»¶
                    tempKeystoreFile.withOutputStream { os ->
                        byte[] decodedBytes = keystoreBase64.decodeBase64() // Groovy çš„ String æ‰©å±•æ–¹æ³•
                        if (decodedBytes == null || decodedBytes.length == 0) { // æ£€æŸ¥è§£ç ç»“æœ
                            throw new GradleException("BASE64è§£ç å¤±è´¥ï¼è¯·æ£€æŸ¥STORE_FILE_BASE64å†…å®¹æ˜¯å¦æœ‰æ•ˆä¸”çº¯å‡€ï¼ˆæ— ç©ºæ ¼ã€æ— æ¢è¡Œï¼‰")
                        }
                        os.write(decodedBytes)
                        println "| ä¸´æ—¶å¯†é’¥æ–‡ä»¶å†™å…¥æˆåŠŸ (${decodedBytes.length} bytes) åˆ° ${tempKeystoreFile.absolutePath}"
                    }

                    // éªŒè¯å¯†é’¥æ–‡ä»¶æœ‰æ•ˆæ€§
                    if (!tempKeystoreFile.exists() || tempKeystoreFile.length() == 0) {
                        throw new GradleException("ä¸´æ—¶å¯†é’¥æ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–ä¸ºç©ºï¼")
                    }

                    storeFile tempKeystoreFile
                    // ä½¿ç”¨ Elvis æ“ä½œç¬¦ ?: æä¾›é»˜è®¤ç©ºå­—ç¬¦ä¸²ï¼Œé¿å… NullPointerException
                    storePassword System.getenv("STORE_PASSWORD") ?: "" 
                    keyAlias System.getenv("KEY_ALIAS") ?: ""
                    keyPassword System.getenv("KEY_PASSWORD") ?: ""

                    println "| ç­¾åé…ç½®å·²åº”ç”¨ (é€šè¿‡BASE64)"
                    println "| storeFile: ${storeFile?.absolutePath}"
                    println "| keyAlias: ${keyAlias ? keyAlias.take(1) + '***' : 'æœªè®¾ç½®'}" // é®è”½åˆ«å

                    // æ„å»ºå®Œæˆåè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    gradle.buildFinished {
                        if (tempKeystoreFile.exists()) {
                            tempKeystoreFile.delete()
                            println "| å·²æ¸…ç†ä¸´æ—¶å¯†é’¥æ–‡ä»¶: ${tempKeystoreFile.absolutePath}"
                        }
                    }
                } catch (Exception e) {
                    // æ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œç¡®ä¿ä¸´æ—¶æ–‡ä»¶è¢«æ¸…ç†
                    if (tempKeystoreFile.exists()) {
                        tempKeystoreFile.delete()
                        println "| é”™è¯¯å‘ç”Ÿæ—¶å·²æ¸…ç†ä¸´æ—¶å¯†é’¥æ–‡ä»¶: ${tempKeystoreFile.absolutePath}"
                    }
                    throw new GradleException("ç­¾åé…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡å’ŒBase64å†…å®¹: ${e.message}", e)
                }
            }
            // 3. å›é€€åˆ°propertiesæ–‡ä»¶/å•ç‹¬ç¯å¢ƒå˜é‡
            else {
                println "\nğŸ“ æœªæ‰¾åˆ° STORE_FILE_BASE64 ç¯å¢ƒå˜é‡ï¼Œå°è¯•ä½¿ç”¨ signing.properties æ–‡ä»¶æˆ–å•ç‹¬çš„ç¯å¢ƒå˜é‡é…ç½®..."
                
                def getConfigValue = { String name, String envName ->
                    // ä¼˜å…ˆä» properties æ–‡ä»¶è·å–ï¼Œå…¶æ¬¡ä»ç¯å¢ƒå˜é‡
                    return properties[name] ?: System.getenv(envName)
                }

                def storeFileValue = getConfigValue('storeFile', 'STORE_FILE')
                if (storeFileValue) {
                    storeFile file(storeFileValue)
                    storePassword getConfigValue('storePassword', 'STORE_PASSWORD') ?: ""
                    keyAlias getConfigValue('keyAlias', 'KEY_ALIAS') ?: ""
                    keyPassword getConfigValue('keyPassword', 'KEY_PASSWORD') ?: ""

                    println "| ä½¿ç”¨æ–‡ä»¶è·¯å¾„é…ç½®:"
                    println "| storeFile: ${storeFile?.absolutePath}"
                    println "| keyAlias: ${keyAlias ? keyAlias.take(1) + '***' : 'æœªè®¾ç½®'}"
                } else {
                    println "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„ç­¾åé…ç½®ä¿¡æ¯ã€‚è¯·ç¡®ä¿æä¾›äº† Base64 ç¯å¢ƒå˜é‡æˆ– signing.properties æ–‡ä»¶ã€‚"
                    // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸æ— ç­¾åæ„å»ºï¼ˆè¿™é€šå¸¸åªé€‚ç”¨äºè°ƒè¯•ç‰ˆæœ¬æˆ–ç‰¹å®šæƒ…å†µï¼‰
                }
            }
        }
    }

    // åº”ç”¨ç­¾åé…ç½®åˆ°releaseæ„å»ºç±»å‹
    buildTypes {
        release {
            signingConfig signingConfigs.release
            println "Release æ„å»ºå°†ä½¿ç”¨ç­¾åé…ç½®: ${signingConfig?.name ?: 'æ— ç­¾åé…ç½®'}\n"
        }
    }
}
